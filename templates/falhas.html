{% extends 'base.html' %}

{% block content %}

<style>
    @media print {
        /* Esconde elementos que não devem sair no papel */
        .no-print, 
        .navbar, 
        .btn-close, 
        .modal, 
        header, 
        footer {
            display: none !important;
        }

        /* Ajusta o fundo e remove margens extras */
        body {
            background-color: white !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .container {
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Remove sombras e bordas coloridas para economizar tinta */
        .card {
            box-shadow: none !important;
            border: 1px solid #ccc !important;
            break-inside: avoid; /* Evita quebrar o card no meio da página */
        }

        .card-header {
            background-color: #f8f9fa !important; /* Fundo claro para headers */
            color: black !important;
            border-bottom: 2px solid #000 !important;
        }

        /* Garante que a tabela apareça inteira */
        .table-responsive {
            overflow: visible !important;
        }
        
        table {
            width: 100% !important;
        }

        /* Ajuste para gráficos */
        canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* Força texto preto */
        h1, h2, h3, h4, h5, h6, p, td, th {
            color: #000 !important;
        }
    }
</style>

<div class="container mt-4">
    
    <h3 class="text-center mb-4 text-primary fw-bold">
        <i class="bi bi-exclamation-triangle-fill text-warning"></i> Controle de Falhas e Indisponibilidade
    </h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show no-print" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card shadow-sm mb-5 no-print">
        <div class="card-header {{ 'bg-info' if falha_editar else 'bg-danger' }} text-white">
            <h5 class="mb-0">
                <i class="bi {{ 'bi-pencil-fill' if falha_editar else 'bi-pencil-square' }}"></i> 
                {{ 'Editar Falha Existente' if falha_editar else 'Reportar Nova Falha' }}
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('editar', id=falha_editar.id) if falha_editar else url_for('falhas') }}">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="data_ocorrencia" class="form-label text-danger fw-bold">Data:</label>
                        <input type="date" class="form-control" name="data_ocorrencia" 
                               value="{{ falha_editar.data_registro if falha_editar else data_hoje }}" required>
                    </div>

                    <div class="col-md-9 mb-3">
                        <label for="tipo_falha" class="form-label text-primary fw-bold">Tipo da Falha:</label>
                        <div class="d-flex gap-2">
                            <select class="form-select flex-grow-1" name="tipo_falha" required>
                                <option value="" disabled {{ 'selected' if not falha_editar else '' }}>Selecione...</option>
                                {% for opcao in opcoes_falhas %}
                                <option value="{{ opcao }}" {{ 'selected' if falha_editar and falha_editar.tipo_falha == opcao else '' }}>
                                    {{ opcao }}
                                </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#modalGerenciarTipos" title="Gerenciar Tipos" style="min-width: 40px;">
                                <i class="bi bi-gear-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label text-primary fw-bold">Início:</label>
                        <input type="time" class="form-control" name="hora_inicio" 
                               value="{{ falha_editar.hora_inicio if falha_editar else '' }}" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label text-primary fw-bold">Fim:</label>
                        <input type="time" class="form-control" name="hora_fim"
                               value="{{ falha_editar.hora_fim if falha_editar else '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-primary fw-bold">Descrição:</label>
                        <textarea class="form-control" name="descricao" rows="4" 
                                  placeholder="Detalhes do ocorrido..." 
                                  style="text-transform: uppercase;"
                                  oninput="this.value = this.value.toUpperCase()"
                                  required>{{ falha_editar.descricao if falha_editar else '' }}</textarea>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn {{ 'btn-info text-white' if falha_editar else 'btn-danger text-white' }} fw-bold">
                        <i class="bi {{ 'bi-check-circle' if falha_editar else 'bi-save' }}"></i> 
                        {{ 'Salvar Alterações' if falha_editar else 'Registrar Falha' }}
                    </button>
                    {% if falha_editar %}
                        <a href="{{ url_for('falhas') }}" class="btn btn-secondary">Cancelar Edição</a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0"><i class="bi bi-table"></i> Histórico Detalhado</h5>
            
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-light text-dark fw-bold btn-sm no-print">
                    <i class="bi bi-printer-fill"></i> Imprimir Relatório
                </button>

                <form action="{{ url_for('falhas') }}" method="GET" class="d-flex no-print" style="max-width: 300px;">
                    <div class="input-group input-group-sm">
                        <input type="text" name="search" class="form-control" placeholder="Pesquisar..." value="{{ search_query if search_query else '' }}">
                        <button class="btn btn-secondary" type="submit" title="Buscar">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if search_query %}
                            <a href="{{ url_for('falhas') }}" class="btn btn-danger" title="Limpar Pesquisa">
                                <i class="bi bi-x-lg"></i>
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>

        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 15%;">Data</th>
                            <th style="width: 15%;">Horário</th>
                            <th style="width: 25%;">Tipo de Falha</th>
                            <th style="width: 35%;">Descrição do Ocorrido</th>
                            <th style="width: 10%;" class="text-center no-print">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for falha in historico_completo %}
                        <tr class="{{ 'table-info' if falha_editar and falha_editar.id == falha.id else '' }}">
                            <td class="fw-bold text-secondary">
                                {% if falha.data_registro is string %}
                                    {{ falha.data_registro[8:10] }}/{{ falha.data_registro[5:7] }}/{{ falha.data_registro[0:4] }}
                                {% else %}
                                    {{ falha.data_registro.strftime('%d/%m/%Y') }}
                                {% endif %}
                            </td>
                            <td>
                                {% if falha.hora_inicio %}
                                    {{ falha.hora_inicio }} 
                                    {% if falha.hora_fim %} às {{ falha.hora_fim }} {% endif %}
                                {% else %}
                                    <span class="text-muted small">--:--</span>
                                {% endif %}
                            </td>
                            <td><span class="badge bg-secondary border border-dark text-white">{{ falha.tipo_falha }}</span></td>
                            <td>{{ falha.descricao }}</td>
                            <td class="text-center no-print">
                                <a href="{{ url_for('editar', id=falha.id) }}" class="btn btn-outline-primary btn-sm me-1" title="Editar"><i class="bi bi-pencil-square"></i></a>
                                <a href="{{ url_for('excluir', id=falha.id) }}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Excluir este registro?')" title="Excluir"><i class="bi bi-trash-fill"></i></a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                {% if search_query %}
                                    Nenhuma falha encontrada para: "<strong>{{ search_query }}</strong>"
                                {% else %}
                                    Nenhum registro encontrado.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <h4 class="text-secondary fw-bold mb-3"><i class="bi bi-bar-chart-line-fill"></i> Painel Estatístico</h4>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card bg-primary text-white shadow h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h6 class="card-title text-uppercase opacity-75">Total de Ocorrências</h6>
                    <h1 class="display-3 fw-bold mb-0">{{ total_geral }}</h1>
                    <small>Registros no banco</small>
                </div>
            </div>
        </div>

        <div class="col-md-8 mb-3">
            <div class="card shadow h-100">
                <div class="card-header bg-light fw-bold">Distribuição (% por Tipo)</div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="chartTipoFalha"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light fw-bold">Ranking de Falhas (Quantidade Absoluta)</div>
                <div class="card-body">
                    <canvas id="chartRanking" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade no-print" id="modalGerenciarTipos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="bi bi-gear"></i> Gerenciar Tipos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('gerenciar_tipos') }}" class="mb-4">
            <input type="hidden" name="acao" value="adicionar">
            <label class="form-label fw-bold">Novo Tipo:</label>
            <div class="input-group">
                <input type="text" class="form-control" name="novo_tipo" placeholder="Ex: Lentidão..." required>
                <button type="submit" class="btn btn-success"><i class="bi bi-plus-lg"></i></button>
            </div>
        </form>
        <ul class="list-group list-group-flush">
            {% for opcao in opcoes_falhas %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                {{ opcao }}
                {% if opcao != 'OUTROS' %}
                <form method="POST" action="{{ url_for('gerenciar_tipos') }}" style="margin:0;">
                    <input type="hidden" name="acao" value="excluir">
                    <input type="hidden" name="tipo_nome" value="{{ opcao }}">
                    <button type="submit" class="btn btn-sm text-danger border-0" onclick="return confirm('Excluir?')"><i class="bi bi-trash"></i></button>
                </form>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statsData = [
            {% for stat in estatisticas %}
                { tipo: "{{ stat.tipo_falha }}", qtd: {{ stat.qtd }} },
            {% endfor %}
        ];

        const labels = statsData.map(item => item.tipo);
        const dataValues = statsData.map(item => item.qtd);
        const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF'
        ];

        const ctxDoughnut = document.getElementById('chartTipoFalha').getContext('2d');
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });

        const ctxBar = document.getElementById('chartRanking').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ocorrências',
                    data: dataValues,
                    backgroundColor: '#dc3545',
                    borderRadius: 5,
                    barThickness: 30
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    });
</script>

{% endblock %}