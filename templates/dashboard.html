{% extends 'base.html' %}
{% block title %}Dashboard de Estatísticas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 text-center">Dashboard de Estatísticas</h2>
    <p class="text-center text-muted">Análises visuais das ocorrências do histórico.</p>

    <div class="text-center mb-4 hide-for-print">
        <button onclick="window.print()" class="btn btn-secondary">
            <i class="bi bi-printer-fill"></i> Imprimir Dashboard
        </button>
        <a href="{{ url_for('exportar_dashboard') }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar Relatório Excel
        </a>
    </div>
    <hr class="hide-for-print">

    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card text-white bg-primary text-center h-100 shadow-sm">
                <div class="card-header">Total de Ocorrências Arquivadas</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h1 class="card-title display-4">{{ kpis.total_ocorrencias }}</h1>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card text-white bg-success text-center h-100 shadow-sm">
                <div class="card-header">Delegacia Mais Acionada</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h3 class="card-title">{{ kpis.delegacia_top }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12 mb-3">
            <div class="card text-white bg-info text-center h-100 shadow-sm">
                <div class="card-header">Tempo Médio na DP</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h1 class="card-title">{{ kpis.media_tempo_dp }} <small class="h6">horas</small></h1>
                </div>
            </div>
        </div>
    </div>
    <hr>
    
    <h3 class="mb-3 text-center">Análises Gerais do Período Completo</h3>
    <div class="row">
        
        <div class="col-lg-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-primary"><i class="bi bi-bar-chart-fill"></i> Distribuição de Ocorrências por Fato</h5>
                </div>
                <div class="card-body">
                    {% if dados_fatos_paginados %}
                        <div class="row">
                            {% for grupo_fatos in dados_fatos_paginados %}
                            <div class="col-12 mb-5">
                                <h6 class="text-muted border-bottom pb-2 mb-3">
                                    Ranking {{ (loop.index - 1) * 10 + 1 }} a {{ (loop.index - 1) * 10 + grupo_fatos|length }}
                                </h6>
                                <div style="height: {{ grupo_fatos|length * 40 + 40 }}px;">
                                    <canvas id="graficoFatos-{{ loop.index }}"></canvas>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted py-5">Não há dados para exibir.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-12 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-dark"><i class="bi bi-pie-chart-fill"></i> Ocorrências por Status</h5>
                </div>
                <div class="card-body" style="height: 400px;">
                      {% if status_chart_data and status_chart_data.labels %}
                        <canvas id="graficoStatus"></canvas>
                      {% else %}
                        <p class="text-center text-muted pt-5">Não há dados.</p>
                      {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <hr>

    <h3 class="mb-3 text-center">Análises Mensais</h3>
    
    <h5 class="mb-3 text-center text-muted">Top 3 Fatos por Mês</h5>
    <div class="row">
        {% if dados_mensais %}
            {% for mes_data in dados_mensais %}
                {% if mes_data.top3_fatos.labels %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header fw-bold text-center bg-light">Mês: {{ mes_data.mes }}</div>
                        <div class="card-body"><canvas id="graficoTop3-{{ mes_data.mes }}"></canvas></div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="col-12"><p class="text-center text-muted">Não há dados para exibir o Top 3 mensal.</p></div>
        {% endif %}
    </div>

    <h5 class="mb-3 mt-4 text-center text-muted">Total de Horas por Delegacia (Mensal)</h5>
    <div class="row">
        {% if dados_mensais %}
            {% for mes_data in dados_mensais %}
                {% if mes_data.horas_delegacia.labels %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header fw-bold text-center bg-light">Mês: {{ mes_data.mes }}</div>
                        <div class="card-body"><canvas id="graficoHorasMensal-{{ mes_data.mes }}"></canvas></div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="col-12"><p class="text-center text-muted">Não há dados de tempo para exibir as horas por delegacia.</p></div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Registra o plugin de rótulos de dados
    Chart.register(ChartDataLabels);

    // ======================================================
    // 1. GRÁFICOS DE BARRAS HORIZONTAIS (FATOS) - MODERNO
    // ======================================================
    {% for grupo_fatos in dados_fatos_paginados %}
        const fatosData_{{ loop.index }} = {{ grupo_fatos | tojson }};
        const ctxFatos_{{ loop.index }} = document.getElementById('graficoFatos-{{ loop.index }}').getContext('2d');
        
        new Chart(ctxFatos_{{ loop.index }}, {
            type: 'bar', // Tipo barra
            data: {
                labels: fatosData_{{ loop.index }}.map(item => item.fato),
                datasets: [{
                    label: 'Ocorrências',
                    data: fatosData_{{ loop.index }}.map(item => item.quantidade),
                    // Cor azul bonita (Bootstrap Primary)
                    backgroundColor: 'rgba(13, 110, 253, 0.7)', 
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    borderRadius: 4, // Bordas arredondadas
                    barPercentage: 0.7
                }]
            },
            options: {
                indexAxis: 'y', // Isso transforma em barras horizontais!
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }, // Não precisa de legenda
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value, ctx) => {
                            // Calcula % relativa ao grupo exibido
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = (value * 100 / sum).toFixed(1) + "%";
                            return value + " (" + percentage + ")";
                        },
                        color: '#495057', // Cor cinza escuro para leitura
                        font: { weight: 'bold', size: 12 },
                        offset: 4
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false } // Remove linhas verticais
                    },
                    y: {
                        grid: { display: false }, // Remove linhas horizontais
                        ticks: {
                            font: { size: 11, weight: 'bold' },
                            autoSkip: false // Mostra todos os nomes
                        }
                    }
                }
            }
        });
    {% endfor %}

    // ======================================================
    // 2. GRÁFICO DE STATUS (PIZZA)
    // ======================================================
    {% if status_chart_data and status_chart_data.labels %}
        const statusData = {{ status_chart_data | tojson }};
        const ctxStatus = document.getElementById('graficoStatus').getContext('2d');
        new Chart(ctxStatus, {
            type: 'pie',
            data: {
                labels: statusData.labels,
                datasets: [{
                    data: statusData.data,
                    backgroundColor: [
                        '#198754', '#ffc107', '#0dcaf0', '#dc3545', '#6610f2', '#fd7e14'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Proporção por Status' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0%';
                            return (value * 100 / sum).toFixed(1) + '%';
                        },
                        color: '#fff', font: { weight: 'bold', size: 14 },
                        textShadowBlur: 2, textShadowColor: '#000'
                    }
                }
            }
        });
    {% endif %}

    // ======================================================
    // 3. GRÁFICOS MENSAIS (LOOPS)
    // ======================================================
    {% for mes_data in dados_mensais %}
        // Pizza: Top 3 Fatos do Mês
        {% if mes_data.top3_fatos and mes_data.top3_fatos.labels %}
            const top3Data_{{ loop.index }} = {{ mes_data.top3_fatos | tojson }};
            const ctxTop3_{{ loop.index }} = document.getElementById('graficoTop3-{{ mes_data.mes }}').getContext('2d');
            new Chart(ctxTop3_{{ loop.index }}, {
                type: 'doughnut', // Doughnut fica mais moderno que Pie simples
                data: { labels: top3Data_{{ loop.index }}.labels, datasets: [{ data: top3Data_{{ loop.index }}.data, hoverOffset: 4 }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { boxWidth: 10, font: {size: 10} } },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (sum === 0) return '0%';
                                return (value * 100 / sum).toFixed(0) + '%';
                            },
                            color: '#000', font: { weight: 'bold', size: 11 },
                            anchor: 'center', align: 'center',
                            backgroundColor: 'rgba(255,255,255,0.7)',
                            borderRadius: 3
                        }
                    }
                }
            });
        {% endif %}

        // Pizza: Horas por Delegacia do Mês
        {% if mes_data.horas_delegacia and mes_data.horas_delegacia.labels %}
            const horasData_{{ loop.index }} = {{ mes_data.horas_delegacia | tojson }};
            const ctxHoras_{{ loop.index }} = document.getElementById('graficoHorasMensal-{{ mes_data.mes }}').getContext('2d');
            new Chart(ctxHoras_{{ loop.index }}, {
                type: 'polarArea', // PolarArea varia um pouco visualmente
                data: { labels: horasData_{{ loop.index }}.labels, datasets: [{ data: horasData_{{ loop.index }}.data }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10 } },
                        datalabels: {
                            formatter: (value) => { return value.toFixed(1) + 'h'; },
                            color: '#fff', font: { weight: 'bold' },
                            backgroundColor: '#000', borderRadius: 4, padding: 2
                        }
                    }
                }
            });
        {% endif %}
    {% endfor %}
});
</script>
{% endblock %}