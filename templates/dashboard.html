{% extends 'base.html' %}
{% block title %}Dashboard de Estatísticas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 text-center">Dashboard de Estatísticas</h2>
    <p class="text-center text-muted">Análises visuais das ocorrências do histórico.</p>

    <div class="text-center mb-4 hide-for-print">
        <button onclick="window.print()" class="btn btn-secondary">
            <i class="bi bi-printer-fill"></i> Imprimir Dashboard
        </button>
        <a href="{{ url_for('exportar_dashboard') }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar Relatório Excel
        </a>
    </div>
    <hr class="hide-for-print">

    <!-- Linha dos Indicadores Principais (KPIs) -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card text-white bg-primary text-center h-100">
                <div class="card-header">Total de Ocorrências Arquivadas</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h1 class="card-title display-4">{{ kpis.total_ocorrencias }}</h1>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card text-white bg-success text-center h-100">
                <div class="card-header">Delegacia Mais Acionada</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h3 class="card-title">{{ kpis.delegacia_top }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12 mb-3">
            <div class="card text-white bg-info text-center h-100">
                <div class="card-header">Tempo Médio na DP</div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <h1 class="card-title">{{ kpis.media_tempo_dp }} <small class="h6">horas</small></h1>
                </div>
            </div>
        </div>
    </div>
    <hr>
    
    <h3 class="mb-3 text-center">Análises Gerais do Período Completo</h3>
    <div class="row">
        <!-- Gráfico de Fatos (Paginado em Pizzas) -->
        <div class="col-lg-12 mb-4">
            <div class="card">
                <div class="card-header">Distribuição de Ocorrências por Fato</div>
                <div class="card-body">
                    {% if dados_fatos_paginados %}
                        <div class="row">
                            {% for grupo_fatos in dados_fatos_paginados %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border-0">
                                    <div class="card-header bg-light text-dark border-0">
                                        <strong>Grupo {{ loop.index }}</strong> (Fatos {{ (loop.index - 1) * 10 + 1 }} a {{ (loop.index - 1) * 10 + grupo_fatos|length }})
                                    </div>
                                    <div class="card-body">
                                        <canvas id="graficoFatos-{{ loop.index }}" style="max-height: 350px;"></canvas>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted">Não há dados para exibir.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Status -->
        <div class="col-lg-12 mb-4">
            <div class="card h-100">
                <div class="card-header">Ocorrências por Status</div>
                <div class="card-body" style="height: 400px;">
                     {% if status_chart_data and status_chart_data.labels %}
                        <canvas id="graficoStatus"></canvas>
                     {% else %}
                        <p class="text-center text-muted">Não há dados.</p>
                     {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <hr>

    <!-- Seções de Gráficos Mensais -->
    <h3 class="mb-3 text-center">Análises Mensais</h3>
    
    <!-- Top 3 Fatos por Mês -->
    <h5 class="mb-3 text-center text-muted">Top 3 Fatos por Mês</h5>
    <div class="row">
        {% if dados_mensais %}
            {% for mes_data in dados_mensais %}
                {% if mes_data.top3_fatos.labels %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">Mês: {{ mes_data.mes }}</div>
                        <div class="card-body"><canvas id="graficoTop3-{{ mes_data.mes }}"></canvas></div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="col-12"><p class="text-center text-muted">Não há dados para exibir o Top 3 mensal.</p></div>
        {% endif %}
    </div>

    <!-- Total de Horas por Delegacia (Mensal) -->
    <h5 class="mb-3 mt-4 text-center text-muted">Total de Horas por Delegacia (Mensal)</h5>
    <div class="row">
        {% if dados_mensais %}
            {% for mes_data in dados_mensais %}
                {% if mes_data.horas_delegacia.labels %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">Mês: {{ mes_data.mes }}</div>
                        <div class="card-body"><canvas id="graficoHorasMensal-{{ mes_data.mes }}"></canvas></div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="col-12"><p class="text-center text-muted">Não há dados de tempo para exibir as horas por delegacia.</p></div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    Chart.register(ChartDataLabels);

    // --- Gráficos de Pizza para Fatos (Paginados) ---
    {% for grupo_fatos in dados_fatos_paginados %}
        const fatosData_{{ loop.index }} = {{ grupo_fatos | tojson }};
        const ctxFatos_{{ loop.index }} = document.getElementById('graficoFatos-{{ loop.index }}').getContext('2d');
        
        new Chart(ctxFatos_{{ loop.index }}, {
            type: 'pie',
            data: {
                labels: fatosData_{{ loop.index }}.map(item => item.fato),
                datasets: [{
                    data: fatosData_{{ loop.index }}.map(item => item.quantidade),
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0%';
                            return (value * 100 / sum).toFixed(1) + '%';
                        },
                        color: '#fff', font: { weight: 'bold', size: 11 }
                    }
                }
            }
        });
    {% endfor %}

    // --- Gráfico de Status (Pizza) ---
    {% if status_chart_data and status_chart_data.labels %}
        const statusData = {{ status_chart_data | tojson }};
        const ctxStatus = document.getElementById('graficoStatus').getContext('2d');
        new Chart(ctxStatus, {
            type: 'pie',
            data: {
                labels: statusData.labels,
                datasets: [{
                    data: statusData.data,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Proporção por Status' },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (sum === 0) return '0%';
                            return (value * 100 / sum).toFixed(1) + '%';
                        },
                        color: '#fff', font: { weight: 'bold', size: 14 }
                    }
                }
            }
        });
    {% endif %}

    // --- Gráficos Mensais (Loop) ---
    {% for mes_data in dados_mensais %}
        // Pizza: Top 3 Fatos do Mês
        {% if mes_data.top3_fatos and mes_data.top3_fatos.labels %}
            const top3Data_{{ loop.index }} = {{ mes_data.top3_fatos | tojson }};
            const ctxTop3_{{ loop.index }} = document.getElementById('graficoTop3-{{ mes_data.mes }}').getContext('2d');
            new Chart(ctxTop3_{{ loop.index }}, {
                type: 'pie',
                data: { labels: top3Data_{{ loop.index }}.labels, datasets: [{ data: top3Data_{{ loop.index }}.data, hoverOffset: 4 }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (sum === 0) return '0%';
                                return (value * 100 / sum).toFixed(0) + '%';
                            },
                            color: '#fff', font: { weight: 'bold', size: 12 }
                        }
                    }
                }
            });
        {% endif %}

        // Pizza: Horas por Delegacia do Mês
        {% if mes_data.horas_delegacia and mes_data.horas_delegacia.labels %}
            const horasData_{{ loop.index }} = {{ mes_data.horas_delegacia | tojson }};
            const ctxHoras_{{ loop.index }} = document.getElementById('graficoHorasMensal-{{ mes_data.mes }}').getContext('2d');
            new Chart(ctxHoras_{{ loop.index }}, {
                type: 'pie',
                data: { labels: horasData_{{ loop.index }}.labels, datasets: [{ data: horasData_{{ loop.index }}.data, hoverOffset: 4 }] },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Horas por DP' },
                        datalabels: {
                            formatter: (value) => { return value.toFixed(1) + 'h'; },
                            color: '#fff', font: { weight: 'bold' }
                        }
                    }
                }
            });
        {% endif %}
    {% endfor %}
});
</script>
{% endblock %}